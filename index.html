<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraction</title>
    <style>
      :root {
        --bg: #ffffff;
        --sidebar-bg: #fbfbfa;
        --text: #1a1a1a;
        --text-dim: #8a8a8e;
        --accent: #007aff;
        --border: rgba(0, 0, 0, 0.05);
        --hover: rgba(0, 0, 0, 0.03);
        --toolbar: #ffffff;
        --radius: 12px;
      }

      body.dark-mode {
        --bg: #0a0a0a;
        --sidebar-bg: #121212;
        --text: #f5f5f7;
        --text-dim: #7a7a7a;
        --border: rgba(255, 255, 255, 0.08);
        --hover: rgba(255, 255, 255, 0.05);
        --toolbar: #1c1c1e;
      }

      * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
      body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif; display: flex; height: 100vh; overflow: hidden; transition: background 0.3s ease; }

      #sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 32px 16px; }
      .brand { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; padding: 12px; margin-bottom: 12px; color: var(--text-dim); }
      
      .sidebar-actions { display: flex; flex-direction: column; gap: 2px; margin-bottom: 24px; }
      .btn-action { background: transparent; color: var(--text-dim); border: none; font-weight: 500; text-align: left; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: 0.2s; }
      .btn-action:hover { background: var(--hover); color: var(--text); }

      #notesList { flex: 1; overflow-y: auto; }
      .folder-group { margin-bottom: 28px; }
      .folder-header { font-size: 10px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; padding: 8px 12px; letter-spacing: 1px; opacity: 0.5; }

      .note-item { padding: 8px 12px; border-radius: 8px; margin: 1px 0; cursor: pointer; font-size: 14px; display: flex; justify-content: space-between; align-items: center; transition: 0.15s; color: var(--text-dim); }
      .note-item:hover { background: var(--hover); color: var(--text); }
      .note-item.active { background: var(--hover); font-weight: 600; color: var(--text); }

      /* Command Palette & Context Menu */
      #palette-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.15); backdrop-filter: blur(12px); z-index: 3000; display: none; align-items: flex-start; justify-content: center; padding-top: 15vh; }
      #command-palette { width: 500px; background: var(--toolbar); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow: hidden; }
      #palette-input { width: 100%; border: none; background: transparent; padding: 18px; font-size: 16px; color: var(--text); outline: none; border-bottom: 1px solid var(--border); }
      #palette-results { max-height: 300px; overflow-y: auto; padding: 6px; }
      
      #contextMenu { position: fixed; background: var(--toolbar); border: 1px solid var(--border); border-radius: 10px; padding: 6px; z-index: 4000; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.15); min-width: 150px; }
      .menu-item, .palette-item { padding: 10px 14px; font-size: 13px; cursor: pointer; border-radius: 8px; color: var(--text); display: flex; justify-content: space-between; align-items: center; }
      .menu-item:hover, .palette-item.selected { background: var(--accent); color: white; }

      #main-container { flex: 1; display: flex; flex-direction: column; position: relative; }
      .toolbar { position: absolute; top: 32px; right: 40px; background: var(--toolbar); border: 1px solid var(--border); padding: 4px; border-radius: 12px; display: flex; gap: 2px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

      #editor-scroll { flex: 1; overflow-y: auto; scroll-behavior: smooth; }
      #editor-content { max-width: 720px; margin: 0 auto; width: 100%; padding: 140px 40px; }
      #titleInput { width: 100%; background: transparent; border: none; outline: none; font-size: 42px; font-weight: 800; color: var(--text); margin-bottom: 24px; letter-spacing: -1.2px; }
      #content { outline: none; font-size: 18px; line-height: 1.7; color: var(--text); min-height: 60vh; }

      .tool-btn { background: transparent; border: none; color: var(--text-dim); padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; }
      .tool-btn:hover { background: var(--hover); color: var(--text); }
      .tool-btn.active { background: var(--accent); color: white; }

      .check-row { display: flex; align-items: flex-start; gap: 12px; margin: 10px 0; }
      .check-row input[type="checkbox"] { margin-top: 6px; width: 18px; height: 18px; accent-color: var(--accent); flex-shrink: 0; }
      
      pre { background: var(--hover); padding: 16px; border-radius: 8px; font-family: monospace; font-size: 15px; margin: 16px 0; overflow-x: auto; white-space: pre-wrap; }
      blockquote { border-left: 3px solid var(--accent); margin: 16px 0; padding-left: 20px; color: var(--text-dim); font-style: italic; }
      hr { border: none; border-top: 1px solid var(--border); margin: 32px 0; }
      [contenteditable]:empty:before { content: "Type '/' for commands..."; color: var(--text-dim); opacity: 0.3; pointer-events: none; }
    </style>
  </head>
  <body>

    <div id="palette-overlay">
      <div id="command-palette">
        <input id="palette-input" placeholder="Search commands..." autocomplete="off" />
        <div id="palette-results"></div>
      </div>
    </div>

    <div id="contextMenu">
      <div class="menu-item" onclick="contextPin()"><span>Pin / Unpin</span> <span>ðŸ“Œ</span></div>
      <div class="menu-item" onclick="contextDelete()" style="color: #ff3b30"><span>Delete</span> <span>âœ•</span></div>
    </div>

    <div id="sidebar">
      <div class="brand">Fraction</div>
      <div class="sidebar-actions">
        <button class="btn-action" onclick="createNewNote()">New Note</button>
        <button class="btn-action" onclick="createNewFolder()">New Folder</button>
      </div>
      <div id="notesList"></div>
    </div>

    <div id="main-container">
      <div class="toolbar">
        <button class="tool-btn" onclick="toggleTheme()">ðŸŒ“</button>
        <div style="width:1px; background: var(--border); height: 16px; margin: 6px 4px;"></div>
        <button class="tool-btn" id="btn-bold" onclick="format('bold')">B</button>
        <button class="tool-btn" id="btn-italic" onclick="format('italic')">I</button>
        <button class="tool-btn" onclick="addChecklist()">Checklist</button>
        <div style="width:1px; background: var(--border); height: 16px; margin: 6px 4px;"></div>
        <button class="tool-btn" onclick="adjustFontSize(-2)">A-</button>
        <button class="tool-btn" onclick="adjustFontSize(2)">A+</button>
        <div style="width:1px; background: var(--border); height: 16px; margin: 6px 4px;"></div>
        <button class="tool-btn" onclick="exportNote()">Export</button>
      </div>

      <div id="editor-scroll">
        <div id="editor-content">
          <input id="titleInput" placeholder="Untitled" autocomplete="off" />
          <div id="content" contenteditable="true"></div>
        </div>
      </div>
    </div>

    <script>
      let state = {
        notes: JSON.parse(localStorage.getItem('fraction_v14') || '[]'),
        folders: JSON.parse(localStorage.getItem('fraction_folders_v14') || '["Notes"]'),
        currentIdx: 0,
        darkMode: localStorage.getItem('fraction_theme') === 'dark'
      };

      let savedRange = null;
      let menuTargetIdx = null;

      const commands = [
        { name: 'Heading 1', cmd: 'h1', key: 'H1' },
        { name: 'Heading 2', cmd: 'h2', key: 'H2' },
        { name: 'Normal Text', cmd: 'p', key: 'TEXT' },
        { name: 'Code Block', cmd: 'pre', key: 'CODE' },
        { name: 'Quote Block', cmd: 'blockquote', key: 'QUOTE' },
        { name: 'Insert Divider', cmd: 'hr', key: 'LINE' },
        { name: 'Insert Date', cmd: 'date', key: 'DATE' },
        { name: 'Bulleted List', cmd: 'insertUnorderedList', key: 'LIST' }
      ];

      let selectedCmdIdx = 0;
      let filteredCmds = [...commands];

      const tutorialBody = `
        <div style="font-size: 24px; font-weight: 700; margin-bottom: 12px;">Quick Start Tutorial</div>
        <div class="check-row"><input type="checkbox"> <div contenteditable="true"><b>Commands:</b> Type <b>/</b> anywhere to open the palette.</div></div>
        <div class="check-row"><input type="checkbox"> <div contenteditable="true"><b>Size:</b> Highlight text and click <b>A+</b>. It stays highlighted!</div></div>
        <div class="check-row"><input type="checkbox"> <div contenteditable="true"><b>Right-Click:</b> Right-click any note in the sidebar to ðŸ“Œ Pin or âœ• Delete it.</div></div>
      `;

      if (state.notes.length === 0) {
        state.notes.push({ title: "Getting Started", content: tutorialBody, folder: 'Notes', pinned: true });
      }
      if(state.darkMode) document.body.classList.add('dark-mode');

      function save() {
        const note = state.notes[state.currentIdx];
        if(note) {
          note.content = document.getElementById('content').innerHTML;
          note.title = document.getElementById('titleInput').value;
        }
        localStorage.setItem('fraction_v14', JSON.stringify(state.notes));
        localStorage.setItem('fraction_folders_v14', JSON.stringify(state.folders));
        localStorage.setItem('fraction_theme', state.darkMode ? 'dark' : 'light');
      }

      function renderSidebar() {
        const list = document.getElementById('notesList');
        list.innerHTML = '';
        state.folders.forEach(folderName => {
          const group = document.createElement('div');
          group.className = 'folder-group';
          group.innerHTML = `<div class="folder-header">${folderName}</div>`;
          state.notes.map((n, i) => ({...n, originalIdx: i}))
            .filter(n => n.folder === folderName).sort((a,b) => b.pinned - a.pinned)
            .forEach(note => {
              const item = document.createElement('div');
              item.className = `note-item ${note.originalIdx === state.currentIdx ? 'active' : ''}`;
              item.innerHTML = `<span>${note.title || 'Untitled'}</span> ${note.pinned ? 'ðŸ“Œ' : ''}`;
              item.onclick = () => { save(); state.currentIdx = note.originalIdx; loadNote(); renderSidebar(); };
              item.oncontextmenu = (e) => {
                e.preventDefault();
                menuTargetIdx = note.originalIdx;
                const menu = document.getElementById('contextMenu');
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
              };
              group.appendChild(item);
            });
          list.appendChild(group);
        });
      }

      function loadNote() {
        const note = state.notes[state.currentIdx];
        if(!note) return;
        document.getElementById('titleInput').value = note.title || '';
        document.getElementById('content').innerHTML = note.content || '';
      }

      function toggleTheme() {
        state.darkMode = !state.darkMode;
        document.body.classList.toggle('dark-mode');
        save();
      }

      // --- COMMAND PALETTE ---
      const paletteOverlay = document.getElementById('palette-overlay');
      const paletteInput = document.getElementById('palette-input');
      const paletteResults = document.getElementById('palette-results');

      document.getElementById('content').addEventListener('beforeinput', (e) => {
        if (e.data === '/') {
          e.preventDefault();
          const sel = window.getSelection();
          if (sel.rangeCount) savedRange = sel.getRangeAt(0);
          openPalette();
        }
      });

      function openPalette() {
        paletteOverlay.style.display = 'flex';
        paletteInput.value = '';
        paletteInput.focus();
        filterPalette();
      }

      function closePalette() {
        paletteOverlay.style.display = 'none';
        document.getElementById('content').focus();
      }

      paletteInput.oninput = filterPalette;
      paletteInput.onkeydown = (e) => {
        if (e.key === 'ArrowDown') { e.preventDefault(); selectedCmdIdx = (selectedCmdIdx + 1) % filteredCmds.length; renderPalette(); }
        if (e.key === 'ArrowUp') { e.preventDefault(); selectedCmdIdx = (selectedCmdIdx - 1 + filteredCmds.length) % filteredCmds.length; renderPalette(); }
        if (e.key === 'Enter') { e.preventDefault(); runCommand(filteredCmds[selectedCmdIdx].cmd); }
        if (e.key === 'Escape') closePalette();
      };

      function filterPalette() {
        const val = paletteInput.value.toLowerCase();
        filteredCmds = commands.filter(c => c.name.toLowerCase().includes(val) || c.key.toLowerCase().includes(val));
        selectedCmdIdx = 0;
        renderPalette();
      }

      function renderPalette() {
        paletteResults.innerHTML = filteredCmds.map((c, i) => `
          <div class="palette-item ${i === selectedCmdIdx ? 'selected' : ''}" onmousedown="runCommand('${c.cmd}')">
            <span>${c.name}</span> <b>${c.key}</b>
          </div>
        `).join('');
      }

      function runCommand(type) {
        const sel = window.getSelection();
        sel.removeAllRanges(); sel.addRange(savedRange);
        paletteOverlay.style.display = 'none';
        if (type === 'date') document.execCommand('insertHTML', false, new Date().toLocaleDateString());
        else if (type === 'hr') document.execCommand('insertHorizontalRule');
        else if (type === 'insertUnorderedList') document.execCommand('insertUnorderedList');
        else document.execCommand('formatBlock', false, type);
        save();
      }

      // --- CONTEXT MENU ACTIONS ---
      function contextPin() {
        state.notes[menuTargetIdx].pinned = !state.notes[menuTargetIdx].pinned;
        save(); renderSidebar();
      }

      function contextDelete() {
        if(confirm("Delete this note?")) {
            state.notes.splice(menuTargetIdx, 1);
            if(state.notes.length === 0) state.notes.push({ title: '', content: '', folder: 'Notes', pinned: false });
            state.currentIdx = 0;
            save(); loadNote(); renderSidebar();
        }
      }

      // --- SMART ENTER & EDITING ---
      document.getElementById('content').onkeydown = (e) => {
        if (e.key === 'Enter') {
          const node = window.getSelection().anchorNode.parentElement;
          if (['h1', 'h2', 'pre', 'blockquote'].includes(node.tagName.toLowerCase()) && node.textContent.trim() === "") {
            e.preventDefault(); document.execCommand('formatBlock', false, 'p');
          }
        }
      };

      function addChecklist() {
        const html = `<div class="check-row"><input type="checkbox"><div contenteditable="true" style="outline:none;flex:1">New Task...</div></div>`;
        document.execCommand('insertHTML', false, html);
      }

      function format(cmd) { document.execCommand(cmd, false, null); save(); }

      function adjustFontSize(px) {
        const selection = window.getSelection();
        if (!selection.rangeCount || selection.isCollapsed) return;
        const range = selection.getRangeAt(0);
        const container = selection.anchorNode.parentElement;
        const newSize = (parseFloat(window.getComputedStyle(container).fontSize) + px) + 'px';
        const span = document.createElement('span');
        span.style.cssText = `font-size: ${newSize} !important;`;
        span.appendChild(range.extractContents());
        range.insertNode(span);
        const newRange = document.createRange();
        newRange.selectNodeContents(span);
        selection.removeAllRanges(); selection.addRange(newRange);
        save();
      }

      function createNewNote() {
        save();
        state.notes.unshift({ title: '', content: '', folder: 'Notes', pinned: false });
        state.currentIdx = 0; loadNote(); renderSidebar();
      }

      function createNewFolder() {
        const name = prompt("Folder name:");
        if(name) { state.folders.push(name); save(); renderSidebar(); }
      }

      function exportNote() {
        const note = state.notes[state.currentIdx];
        const blob = new Blob([note.content], {type: 'text/html'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = (note.title || 'Untitled') + '.html';
        link.click();
      }

      document.getElementById('titleInput').oninput = () => { state.notes[state.currentIdx].title = document.getElementById('titleInput').value; renderSidebar(); save(); };
      document.getElementById('content').oninput = save;
      window.onclick = () => { 
        document.getElementById('contextMenu').style.display = 'none';
        if (!event.target.closest('#palette-overlay')) paletteOverlay.style.display = 'none';
      };

      renderSidebar();
      loadNote();
    </script>
  </body>
</html>
