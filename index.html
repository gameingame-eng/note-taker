<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Minimal Notes</title>
    <style>
      :root {
        --bg: #0d0d0d;
        --bg2: #111;
        --bg3: #181818;
        --text: #f5f5f5;
        --text-muted: #9a9a9a;
        --accent: #4f8cff;
        --border: #1f1f1f;
        --radius: 8px;
        --fast: 0.18s ease;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: Inter, sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* SIDEBAR */
      #sidebar {
        width: 260px;
        background: var(--bg2);
        border-right: 1px solid var(--border);
        padding: 16px;
        display: flex;
        flex-direction: column;
      }

      #newNoteBtn {
        background: var(--bg3);
        border: none;
        padding: 10px;
        border-radius: var(--radius);
        color: var(--text);
        cursor: pointer;
        transition: var(--fast);
        margin-bottom: 16px;
      }
      #newNoteBtn:hover {
        background: #222;
      }

      .note-item {
        background: var(--bg3);
        padding: 10px;
        border-radius: var(--radius);
        margin-bottom: 10px;
        cursor: grab;
        transition: var(--fast);
        position: relative;
      }
      .note-item:hover {
        background: #222;
      }

      .note-item.active {
        border: 1px solid var(--accent);
        background: rgba(79, 140, 255, 0.1);
      }

      .note-item.drag-over {
        outline: 1px dashed var(--accent);
      }

      .delete-btn {
        position: absolute;
        right: 8px;
        top: 8px;
        font-size: 14px;
        color: #888;
        cursor: pointer;
        transition: var(--fast);
      }
      .delete-btn:hover {
        color: #ff4f4f;
      }

      /* EDITOR */
      #editor {
        flex: 1;
        padding: 24px;
        display: flex;
        flex-direction: column;
      }

      #titleInput {
        background: transparent;
        border: none;
        outline: none;
        font-size: 26px;
        font-weight: 600;
        margin-bottom: 12px;
        color: var(--text);
      }

      /* TOOLBAR */
      #toolbar {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .tool-btn {
        background: var(--bg3);
        border: 1px solid var(--border);
        padding: 6px 10px;
        border-radius: var(--radius);
        cursor: pointer;
        color: var(--text-muted);
        font-size: 13px;
        transition: var(--fast);
      }
      .tool-btn:hover {
        background: #222;
        color: var(--text);
      }

      /* CONTENTEDITABLE */
      #contentEditable {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: var(--text);
        font-size: 16px;
        line-height: 1.6;
        padding-right: 10px;
        overflow-y: auto;
      }

      .fade-in {
        animation: fadeIn 0.2s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* CHECKLIST */
      .check-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 4px 0;
      }

      .check-item input {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <button id="newNoteBtn">+ New Note</button>
      <div id="notesList"></div>
    </div>

    <div id="editor">
      <input id="titleInput" placeholder="Title..." />

      <div id="toolbar">
        <button class="tool-btn" data-action="h1">H1</button>
        <button class="tool-btn" data-action="h2">H2</button>
        <button class="tool-btn" data-action="h3">H3</button>
        <button class="tool-btn" data-action="check">Checklist</button>
      </div>

      <div id="contentEditable" contenteditable="true"></div>
    </div>

    <script>
      /* -------------------------
   DATA + STORAGE
--------------------------*/
      let notes = JSON.parse(localStorage.getItem('notes_v8') || '[]');
      let current = 0;

      function ensureNoteShape(note) {
        if (note.manualTitle === undefined) note.manualTitle = false;
        return note;
      }

      notes = notes.map(ensureNoteShape);

      function save() {
        notes[current].content =
          document.getElementById('contentEditable').innerHTML;
        notes[current].title = document.getElementById('titleInput').value;
        localStorage.setItem('notes_v8', JSON.stringify(notes));
      }

      /* -------------------------
   RENDER NOTES LIST
--------------------------*/
      const notesList = document.getElementById('notesList');

      function renderNotes() {
        notesList.innerHTML = '';
        notes.forEach((note, i) => {
          const div = document.createElement('div');
          div.className = 'note-item' + (i === current ? ' active' : '');
          div.draggable = true;
          div.dataset.index = i;
          div.innerHTML = `
            <strong>${note.title || 'Untitled'}</strong><br>
            <small>${note.content.replace(/<[^>]+>/g, '').slice(0, 40)}</small>
            <div class="delete-btn" data-del="${i}">ðŸ—‘</div>
        `;
          div.addEventListener('click', (ev) => {
            if (ev.target.dataset.del !== undefined) return;
            current = i;
            loadNote(true);
            renderNotes();
          });
          addDragEvents(div);
          notesList.appendChild(div);
        });
      }

      /* -------------------------
   LOAD NOTE INTO EDITOR (with fade)
--------------------------*/
      function loadNote(withFade = false) {
        const note = ensureNoteShape(notes[current]);
        const titleEl = document.getElementById('titleInput');
        const contentEl = document.getElementById('contentEditable');

        titleEl.value = note.title;
        contentEl.innerHTML = note.content;

        if (withFade) {
          contentEl.classList.remove('fade-in');
          void contentEl.offsetWidth; // force reflow
          contentEl.classList.add('fade-in');
        }
      }

      /* -------------------------
   CREATE NEW NOTE
--------------------------*/
      document.getElementById('newNoteBtn').onclick = () => {
        notes.unshift({ title: 'Untitled', content: '', manualTitle: false });
        current = 0;

        document.getElementById('titleInput').value = '';
        document.getElementById('contentEditable').innerHTML = '';

        save();
        renderNotes();
        loadNote(true);
      };

      /* -------------------------
   DELETE NOTE
--------------------------*/
      notesList.addEventListener('click', (e) => {
        if (e.target.dataset.del !== undefined) {
          const index = Number(e.target.dataset.del);
          notes.splice(index, 1);
          if (notes.length === 0) {
            notes.push({ title: 'Untitled', content: '', manualTitle: false });
            current = 0;
          } else if (current >= notes.length) {
            current = notes.length - 1;
          }
          save();
          renderNotes();
          loadNote(true);
          e.stopPropagation();
        }
      });

      /* -------------------------
   TITLE LIVE UPDATE (marks manual)
--------------------------*/
      document.getElementById('titleInput').oninput = () => {
        const titleEl = document.getElementById('titleInput');
        notes[current].title = titleEl.value;
        notes[current].manualTitle = titleEl.value.trim().length > 0;
        save();
        renderNotes();
      };

      /* -------------------------
   TOOLBAR ACTIONS
--------------------------*/
      document.getElementById('toolbar').onclick = (e) => {
        if (!e.target.dataset.action) return;

        const action = e.target.dataset.action;
        const editor = document.getElementById('contentEditable');

        if (action === 'check') {
          const div = document.createElement('div');
          div.className = 'check-item';
          div.innerHTML = `<input type="checkbox"><span>New task</span>`;
          editor.appendChild(div);
          save();
          renderNotes();
          return;
        }

        document.execCommand('formatBlock', false, action);
        save();
        renderNotes();
      };

      /* -------------------------
   CHECKLIST ENTER BEHAVIOR
--------------------------*/
      document
        .getElementById('contentEditable')
        .addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const sel = window.getSelection();
            const node = sel.anchorNode;
            const checkItem =
              node &&
              node.parentElement &&
              node.parentElement.closest('.check-item');

            if (checkItem) {
              e.preventDefault();

              const span = checkItem.querySelector('span');
              if (span && span.textContent.trim() === '') {
                const br = document.createElement('br');
                checkItem.after(br);
                checkItem.remove();

                const range = document.createRange();
                range.setStartAfter(br);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
                save();
                return;
              }

              const newItem = document.createElement('div');
              newItem.className = 'check-item';
              newItem.innerHTML = `<input type="checkbox"><span></span>`;

              checkItem.after(newItem);

              const range = document.createRange();
              range.setStart(newItem.querySelector('span'), 0);
              range.collapse(true);

              sel.removeAllRanges();
              sel.addRange(range);

              save();
            }
          }
        });

      /* -------------------------
   AUTO TITLE FROM FIRST LINE (respects manualTitle)
--------------------------*/
      document
        .getElementById('contentEditable')
        .addEventListener('input', () => {
          const editor = document.getElementById('contentEditable');
          const text = editor.innerText || '';
          const lines = text
            .split('\n')
            .map((l) => l.trim())
            .filter((l) => l.length > 0);

          const note = ensureNoteShape(notes[current]);
          const titleEl = document.getElementById('titleInput');
          const currentTitle = titleEl.value.trim();

          const shouldAutoTitle =
            !note.manualTitle &&
            (currentTitle === '' || currentTitle === 'Untitled');

          if (shouldAutoTitle && lines.length > 0) {
            const newTitle = lines[0].slice(0, 60);
            note.title = newTitle;
            titleEl.value = newTitle;
          }

          save();
          renderNotes();
        });

      /* -------------------------
   DRAG & DROP REORDER
--------------------------*/
      let dragIndex = null;

      function addDragEvents(el) {
        el.addEventListener('dragstart', (e) => {
          dragIndex = Number(e.target.dataset.index);
          e.dataTransfer.effectAllowed = 'move';
        });

        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          el.classList.add('drag-over');
        });

        el.addEventListener('dragleave', () => {
          el.classList.remove('drag-over');
        });

        el.addEventListener('drop', (e) => {
          e.preventDefault();
          el.classList.remove('drag-over');
          const targetItem = e.target.closest('.note-item');
          if (!targetItem) return;
          const targetIndex = Number(targetItem.dataset.index);
          if (dragIndex === null || targetIndex === dragIndex) return;

          const moved = notes.splice(dragIndex, 1)[0];
          notes.splice(targetIndex, 0, moved);

          if (current === dragIndex) current = targetIndex;
          else if (dragIndex < current && targetIndex >= current) current -= 1;
          else if (dragIndex > current && targetIndex <= current) current += 1;

          save();
          renderNotes();
        });

        el.addEventListener('dragend', () => {
          dragIndex = null;
          document
            .querySelectorAll('.note-item')
            .forEach((i) => i.classList.remove('drag-over'));
        });
      }

      /* -------------------------
   INIT
--------------------------*/
      if (notes.length === 0) {
        notes.push({ title: 'Welcome', content: '', manualTitle: false });
      }
      renderNotes();
      loadNote(true);
    </script>
  </body>
</html>
